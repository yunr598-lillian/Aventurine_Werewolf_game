<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Aventurine's Werewolf Game</title>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&display=swap');

    :root {
        --aventurine-gold: #D4AF37;
        --aventurine-dark: #1A1A1A;
        --aventurine-light: #F4E4BC;
        --bg-gradient: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
        --glass: rgba(255, 255, 255, 0.05);
        --neon-glow: 0 0 10px rgba(212, 175, 55, 0.5);
    }

    * { box-sizing: border-box; user-select: none; }

    body {
        margin: 0;
        padding: 0;
        font-family: 'Noto Sans SC', sans-serif;
        background: #000;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        color: var(--aventurine-light);
    }

    #game-container {
        width: 100%;
        max-width: 450px;
        height: 600px;
        background: var(--bg-gradient);
        border: 2px solid var(--aventurine-gold);
        border-radius: 20px;
        position: relative;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        display: flex;
        flex-direction: column;
    }

    .screen {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: var(--aventurine-dark);
        transition: opacity 0.5s ease;
        z-index: 10;
        padding: 20px;
        overflow-y: auto;
    }

    .hidden { opacity: 0; pointer-events: none; z-index: -1; }

    .avatar-large {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        border: 3px solid var(--aventurine-gold);
        box-shadow: var(--neon-glow);
        margin-bottom: 15px;
        object-fit: cover;
        background-color: #333;
    }

    h1, h2 { color: var(--aventurine-gold); margin: 10px 0; text-align: center; }
    p { font-size: 14px; color: #ccc; text-align: center; max-width: 80%; }

    .jelly-btn {
        background: linear-gradient(45deg, #D4AF37, #FDB931);
        color: #000;
        border: none;
        padding: 12px 30px;
        font-size: 16px;
        font-weight: bold;
        border-radius: 25px;
        cursor: pointer;
        margin-top: 20px;
        box-shadow: 0 5px 15px rgba(212, 175, 55, 0.4);
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        animation: jelly 2s infinite;
    }
    .jelly-btn:active { transform: scale(0.9); }
    @keyframes jelly {
        0%, 100% { transform: scale(1, 1); }
        25% { transform: scale(0.9, 1.1); }
        50% { transform: scale(1.1, 0.9); }
        75% { transform: scale(0.95, 1.05); }
    }

    input[type="text"] {
        background: rgba(255,255,255,0.1);
        border: 1px solid var(--aventurine-gold);
        color: white;
        padding: 10px;
        border-radius: 8px;
        width: 80%;
        margin-top: 10px;
        text-align: center;
    }

    .player-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 5px;
        width: 100%;
        padding: 10px;
        background: rgba(0,0,0,0.3);
    }
    .player-token {
        display: flex;
        flex-direction: column;
        align-items: center;
        cursor: pointer;
        position: relative;
    }
    .player-img {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        border: 2px solid #555;
        background: #222;
        overflow: hidden;
        transition: all 0.2s;
    }
    .player-img img { width: 100%; height: 100%; object-fit: cover; }
    .player-token.active .player-img { border-color: var(--aventurine-gold); box-shadow: 0 0 5px var(--aventurine-gold); }
    .player-token.dead .player-img { filter: grayscale(100%); opacity: 0.5; border-color: red; }
    .player-name { font-size: 9px; margin-top: 2px; text-align: center; overflow: hidden; white-space: nowrap; width: 100%; text-overflow: ellipsis; }

    #game-area {
        flex: 1;
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        overflow-y: auto;
        padding-bottom: 80px;
    }

    .log-box {
        width: 95%;
        flex: 1;
        overflow-y: auto;
        font-size: 13px;
        padding: 10px;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    .log-entry { padding: 8px; border-radius: 6px; background: rgba(255,255,255,0.05); line-height: 1.4; }
    .log-entry strong { color: var(--aventurine-gold); }
    .log-system { color: #888; font-style: italic; text-align: center; border: none; background: transparent; padding-top: 10px; }

    .card-container { perspective: 1000px; width: 150px; height: 220px; margin: 20px auto; cursor: pointer; }
    .card-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.8s; transform-style: preserve-3d; }
    .flipped .card-inner { transform: rotateY(180deg); }
    .card-front, .card-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 10px; display: flex; align-items: center; justify-content: center; border: 2px solid var(--aventurine-gold); background: #000; box-shadow: var(--neon-glow); flex-direction: column;}
    .card-front { color: var(--aventurine-gold); font-size: 40px; }
    .card-back { transform: rotateY(180deg); color: #fff; padding: 10px; }
    .role-icon { font-size: 40px; margin-bottom: 10px; }

    .action-panel {
        width: 100%;
        background: #111;
        border-top: 1px solid var(--aventurine-gold);
        padding: 10px;
        max-height: 220px;
        overflow-y: auto;
        position: absolute;
        bottom: 0;
        z-index: 20;
    }
    
    .option-btn {
        display: block;
        width: 100%;
        padding: 10px;
        margin-bottom: 6px;
        background: rgba(212, 175, 55, 0.1);
        border: 1px solid rgba(212, 175, 55, 0.3);
        color: #ddd;
        border-radius: 5px;
        text-align: left;
        font-size: 13px;
        cursor: pointer;
    }
    .option-btn:hover { background: rgba(212, 175, 55, 0.3); }

    .modal {
        position: absolute;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.92);
        z-index: 100;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 20px;
        opacity: 0; pointer-events: none; transition: opacity 0.3s;
    }
    .modal.show { opacity: 1; pointer-events: auto; }
    .modal-content {
        background: #1a1a1a;
        border: 1px solid var(--aventurine-gold);
        padding: 20px;
        border-radius: 10px;
        max-height: 80%;
        overflow-y: auto;
        width: 100%;
        color: #eee;
        white-space: pre-wrap;
        font-size: 14px;
        line-height: 1.6;
    }
    .close-btn {
        position: absolute;
        top: 15px; right: 15px;
        color: var(--aventurine-gold);
        font-size: 28px;
        cursor: pointer;
        background: none; border: none;
    }

    .res-img { width: 80px; height: 80px; border-radius: 50%; border: 2px solid var(--aventurine-gold); overflow: hidden; background: #333;}
    .res-img img { width: 100%; height: 100%; object-fit: cover; }
    .result-avatars { display: flex; gap: 30px; margin-top: 20px; }
    .res-av { text-align: center; cursor: pointer; }

    ::-webkit-scrollbar { width: 5px; }
    ::-webkit-scrollbar-thumb { background: var(--aventurine-gold); border-radius: 3px; }
</style>
</head>
<body>

<div id="game-container">
    <div id="screen-start" class="screen">
        <img src="https://youke.xn--y7xa690gmna.cn/s1/2026/02/04/6982d4672b9bb.webp" class="avatar-large">
        <h2>ç ‚é‡‘<span style="font-size:12px; color:#888;"> (Aventurine)</span></h2>
        <p>â€œå“å‘€ï¼Œæœ‹å‹ï¼Œå·¥ä½œå¤ªç´¯äº†å§ï¼Ÿ<br>ä¸å¦‚æ¥é™ªæˆ‘ç©ä¸ªå°æ¸¸æˆæ”¾æ¾ä¸€ä¸‹ï¼Ÿâ€</p>
        <p style="font-size:10px; color:var(--aventurine-gold);">*æŠ›èµ·ä¸€æšé‡‘å¸*</p>
        <button class="jelly-btn" onclick="goToSetup()">ğŸ² ä¸€èµ·æ¥ç©ç‹¼äººæ€</button>
    </div>

    <div id="screen-setup" class="screen hidden">
        <div id="user-avatar-preview" class="avatar-large" onclick="document.getElementById('avatar-upload').click()" style="display:flex; align-items:center; justify-content:center; cursor:pointer; overflow:hidden;">
          <img id="preview-img" src="https://youke.xn--y7xa690gmna.cn/s1/2026/02/04/69831b347b227.webp" style="width:100%; height:100%; object-fit:cover;">
        </div>
        <input type="file" id="avatar-upload" hidden accept="image/*" onchange="handleAvatarUpload(this)">
        <p>ç‚¹ä¸€ç‚¹å¤´åƒå¯ä»¥ä¸Šä¼ ç…§ç‰‡ï¼Œ<br>å†ç»™è‡ªå·±èµ·ä¸ªåå­—å§~</p>
        <input type="text" id="user-name-input" value="å°å§" maxlength="8">
        <button class="jelly-btn" onclick="startGame()">ç¡®è®¤å…¥å±€ âœ…</button>
    </div>

    <div id="screen-game" class="screen hidden" style="justify-content: flex-start; padding: 0;">
        <div class="player-grid" id="player-grid"></div>
        <div id="game-area">
          <div id="role-reveal-area" style="text-align: center; width: 100%; display:none;">
          <h3>ä½ çš„èº«ä»½ç‰Œ</h3>
          <div class="card-container" onclick="this.classList.toggle('flipped')">
          <div class="card-inner">
          <div class="card-front">â™ ï¸<br><span style="font-size:12px">ç‚¹å‡»ç¿»è½¬</span></div>
          <div class="card-back" id="user-role-card"></div>
          </div>
          </div>
          <button class="jelly-btn" onclick="finishRoleView()" style="padding: 8px 20px; font-size:12px;">è®°ä½äº†</button>
          </div>
          <div id="game-log" class="log-box">
          <div class="log-system">--- æ¸¸æˆå¼€å§‹ ---</div>
          </div>
        </div>
        <div id="action-panel" class="action-panel" style="display:none;"></div>
    </div>

    <div id="screen-end" class="screen hidden">
        <h1 id="winner-title">æ¸¸æˆç»“æŸ</h1>
        <p id="end-reason">...</p>
        <div class="log-box" id="end-roles" style="height: 150px; flex:none; width:90%;"></div>
        <div class="result-avatars">
          <div class="res-av" onclick="showReflection('char')">
          <div class="res-img"><img src="https://youke.xn--y7xa690gmna.cn/s1/2026/02/04/6982d4672b9bb.webp"></div>
          <p>ç ‚é‡‘çš„<br>ç©åæ„Ÿ</p>
          </div>
          <div class="res-av" onclick="showReflection('user')">
          <div class="res-img" id="user-end-avatar-box">ğŸ±</div>
          <p>ä½ çš„<br>ç©åæ„Ÿ</p>
          </div>
        </div>
        <button class="jelly-btn" onclick="location.reload()" style="margin-top:20px; transform: scale(0.8);">å†æ¥ä¸€å±€</button>
    </div>

    <div id="thought-modal" class="modal">
        <button class="close-btn" onclick="closeModal()">Ã—</button>
        <div class="modal-content" id="modal-text"></div>
    </div>
</div>

<script>
    const CHAR_NAME = "ç ‚é‡‘";
    let USER_NAME = "å°å§";
    let USER_AVATAR = "https://youke.xn--y7xa690gmna.cn/s1/2026/02/04/69831b347b227.webp";
    
    const ROLE_POOL = ['ç‹¼äºº', 'ç‹¼äºº', 'é¢„è¨€å®¶', 'å¥³å·«', 'çŒäºº', 'å®ˆå«', 'å¹³æ°‘', 'å¹³æ°‘', 'å¹³æ°‘', 'å¹³æ°‘'];
    
    const PLAYERS_DATA = [
        { id: 0, name: CHAR_NAME, img: 'https://youke.xn--y7xa690gmna.cn/s1/2026/02/04/6982d4672b9bb.webp' },
        { id: 1, name: USER_NAME, img: 'user' }, 
        { id: 2, name: 'æ‰˜å¸•', img: 'https://youke.xn--y7xa690gmna.cn/s1/2026/02/04/6982d466a5d9a.webp' },
        { id: 3, name: 'èˆ’ä¿±', img: 'https://youke.xn--y7xa690gmna.cn/s1/2026/02/04/6982d46693fbb.webp' },
        { id: 4, name: 'æ‹‰å¸å¥¥', img: 'https://youke.xn--y7xa690gmna.cn/s1/2026/02/04/6982d464aa5e1.webp' },
        { id: 5, name: 'ç¿¡ç¿ ', img: 'https://youke.xn--y7xa690gmna.cn/s1/2026/02/04/6982d4678cf1b.webp' },
        { id: 6, name: 'æ˜ŸæœŸæ—¥', img: 'https://youke.xn--y7xa690gmna.cn/s1/2026/02/04/6982d47429435.webp' },
        { id: 7, name: 'çŸ¥æ›´é¸Ÿ', img: 'https://youke.xn--y7xa690gmna.cn/s1/2026/02/04/6982d474a0156.webp' },
        { id: 8, name: 'ä¸¹æ’', img: 'https://youke.xn--y7xa690gmna.cn/s1/2026/02/04/6982d4755ef96.webp' },
        { id: 9, name: 'å¤§é»‘å¡”', img: 'https://youke.xn--y7xa690gmna.cn/s1/2026/02/04/6982d47800531.webp' }
    ];

    let players = [];
    let round = 1;
    let turnPhase = 'setup'; 
    let gameLog = document.getElementById('game-log');
    let actionPanel = document.getElementById('action-panel');
    let playerGrid = document.getElementById('player-grid');
    
    let nightKillTarget = -1;
    let witchPoisonTarget = -1;
    let witchHealUsed = false;
    let witchPoisonUsed = false;
    let guardTarget = -1;
    let lastGuardTarget = -1;
    let savedByWitch = false;

    function handleAvatarUpload(input) {
        if (input.files && input.files[0]) {
          const reader = new FileReader();
          reader.onload = function(e) {
          USER_AVATAR = e.target.result;
          document.getElementById('preview-img').src = USER_AVATAR;
          }
          reader.readAsDataURL(input.files[0]);
        }
    }

    function goToSetup() {
        document.getElementById('screen-start').classList.add('hidden');
        document.getElementById('screen-setup').classList.remove('hidden');
    }

    function startGame() {
        const input = document.getElementById('user-name-input').value;
        if(input.trim()) USER_NAME = input.trim();
        PLAYERS_DATA[1].name = USER_NAME;
        
        let shuffledRoles;
        let attempt = 0;
        do {
          shuffledRoles = [...ROLE_POOL].sort(() => Math.random() - 0.5);
          attempt++;
        } while(shuffledRoles[1] === 'å¹³æ°‘' && attempt < 5 && Math.random() < 0.6);

        players = PLAYERS_DATA.map((p, i) => ({
          ...p,
          role: shuffledRoles[i],
          alive: true,
          isUser: i === 1
        }));

        document.getElementById('screen-setup').classList.add('hidden');
        document.getElementById('screen-game').classList.remove('hidden');
        document.getElementById('user-end-avatar-box').innerHTML = `<img src="${USER_AVATAR}" style="width:100%; height:100%; object-fit:cover;">`;
        
        renderPlayers();
        showRoleReveal();
    }

    function showRoleReveal() {
        const user = players[1];
        const cardBack = document.getElementById('user-role-card');
        const iconMap = {'ç‹¼äºº':'ğŸº', 'é¢„è¨€å®¶':'ğŸ”®', 'å¥³å·«':'ğŸ§ª', 'çŒäºº':'ğŸ”«', 'å®ˆå«':'ğŸ›¡ï¸', 'å¹³æ°‘':'ğŸ‘±'};
        
        cardBack.innerHTML = `<div class="role-icon">${iconMap[user.role]}</div><h3>${user.role}</h3><p style="font-size:10px;">è®°å¾—è—å¥½èº«ä»½å“¦~</p>`;
        document.getElementById('role-reveal-area').style.display = 'block';
        document.getElementById('game-log').style.display = 'none';
    }

    function finishRoleView() {
        document.getElementById('role-reveal-area').style.display = 'none';
        document.getElementById('game-log').style.display = 'flex';
        startNight();
    }

    function renderPlayers() {
        playerGrid.innerHTML = '';
        players.forEach(p => {
          let div = document.createElement('div');
          div.className = `player-token ${p.alive ? 'active' : 'dead'}`;
          let imgUrl = p.id === 1 ? USER_AVATAR : p.img;
          div.innerHTML = `<div class="player-img"><img src="${imgUrl}"></div><div class="player-name">${p.id+1}.${p.name}</div>`;
          div.onclick = () => showPlayerThought(p);
          playerGrid.appendChild(div);
        });
    }

    function showPlayerThought(player) {
        if(!player.alive) { openModal(`<strong>${player.name}ï¼š</strong>\n\nâ€œï¼ˆå·²ç»ç¦»åœºï¼Œåªå‰©ä¸‹ä¸€ä¸ªç©ºåº§ä½ï¼‰...â€`); return; }
        
        const thoughtsDB = {
          'ç ‚é‡‘': ["è¿™å±€è°åœ¨æ’’è°å‘¢ï¼ŸçœŸæœ‰è¶£", "åªè¦ç­¹ç å¤Ÿå¤šï¼Œæ²¡æœ‰èµ¢ä¸äº†çš„å±€ã€‚", "å¦‚æœä½ æ˜¯ç‹¼ï¼Œè®°å¾—è—å¥½å°¾å·´ï¼Œåˆ«è®©æˆ‘æŠ“ä½äº†ã€‚", `å°${USER_NAME}çœ‹èµ·æ¥å¾ˆå›°å•Šï¼Œè¦ä¸è¦é€æ¯å’–å•¡ï¼Ÿ`],
          'æ‰˜å¸•': ["è´¦è´¦å¥½åƒé—»åˆ°äº†â€˜åè´¦â€™çš„å‘³é“ã€‚", "è¿™å±€çš„æ”¶ç›Šç‡...ç›®å‰çœ‹ä¸å¤ªä¹è§‚ã€‚", "ç‹¼äººèƒ½ä¸èƒ½å¿«ç‚¹è‡ªé¦–ï¼Ÿ", "åªè¦ä¸æ˜¯èµ”é’±ï¼Œæ€ä¹ˆéƒ½è¡Œã€‚"],
          'æ‹‰å¸å¥¥': ["é›¶åˆ†ã€‚è¿™ç¾¤äººçš„é€»è¾‘å…¨æ˜¯æ¼æ´ã€‚", "æ„šè ¢æ˜¯æ— å¯æ•‘è¯çš„ï¼Œå°¤å…¶æ˜¯é‚£ä¸ªä¸€ç›´å‘å‘†çš„å®¶ä¼™ã€‚", "è‹¥æ­¤æ—¶æ²‰é»˜ï¼Œä¾¿æ˜¯å¸®å‡¶ã€‚", "åŸºäºæ¦‚ç‡å­¦ï¼Œä½ æ˜¯ç‹¼çš„æ¦‚ç‡åœ¨ä¸Šå‡ã€‚"],
          'å¤§é»‘å¡”': ["è¿™ç§ä½çº§æ¸¸æˆæœ‰ä»€ä¹ˆå¥½ç©çš„ï¼Ÿæˆ‘æƒ³å›ç©ºé—´ç«™äº†ã€‚", "æ¨¡æ‹Ÿå®‡å®™æ¯”è¿™æœ‰æ„æ€å¤šäº†ï¼Œå¿«ç‚¹ç»“æŸå§ã€‚", "è½¬åœˆåœˆ~è½¬åœˆåœˆ~è½¬åœˆåœˆ~", "ä½ ä»¬éƒ½æ˜¯å‚»ç“œå—ï¼Ÿè¿™ä¹ˆç®€å•éƒ½çœ‹ä¸å‡ºæ¥ï¼ï¼ï¼"],
          'æ˜ŸæœŸæ—¥': ["ç§©åºå¿…å°†é™ä¸´ï¼Œè°è¨€ç»ˆå°†è¢«æ­ç©¿ã€‚", "è¯·è¯šå®é¢å¯¹å†…å¿ƒã€‚", "å¦‚æœä½ æœ‰ç½ªï¼Œæˆ‘ä¼šçŸ¥é“ã€‚", "æ„¿å¤ªä¸€çš„å…‰è¾‰ç…§è€€è¿™ç‰‡æ··æ²Œã€‚"],
          'çŸ¥æ›´é¸Ÿ': ["å¸Œæœ›å¤§å®¶éƒ½èƒ½å’Œå¹³ç›¸å¤„ï¼Œä¸è¦åµæ¶...", "è¿™å°±æ˜¯å“¥å“¥è¯´çš„å¾ˆæœ‰è¶£çš„æ¸¸æˆï¼Ÿ", "è¿™é¦–æ­Œï¼ŒçŒ®ç»™ä»Šæ™šçš„å—å®³è€…ã€‚", "è¯·ç›¸ä¿¡æˆ‘ï¼Œæˆ‘çœŸçš„æ²¡æœ‰è¯´è°ã€‚"],
          'ç¿¡ç¿ ': ["åœ¨è¿™ä¸ªèµŒå±€é‡Œï¼Œä½ èƒ½ä»˜å‡ºä»€ä¹ˆä»£ä»·ï¼Ÿ", "äººå¿ƒæ˜¯æœ€æ˜“æ“æ§çš„èµ„äº§ï¼ŒçœŸæ˜¯å»‰ä»·ã€‚", "äº¤æ¢å—ï¼Ÿç”¨ä½ çš„èº«ä»½æ¢æˆ‘çš„åº‡æŠ¤ã€‚", "åˆ«å¤ªè´ªå¿ƒå“¦ï¼Œè´ªå©ªæ˜¯åŸç½ªã€‚"],
          'ä¸¹æ’': ["...æˆ‘ä¸æ“…é•¿è¿™ç§æ¸¸æˆï¼Œåˆ«çœ‹æˆ‘ã€‚", "ä¿æŒæ²‰é»˜æ¯”è¾ƒå¥½ï¼Œå¤šè¯´å¤šé”™ã€‚", "å°å¿ƒèƒŒåï¼Œæœ‰æ€æ°”ã€‚", "é‚£ä¸ªäººçœ¼ç¥ä¸å¯¹ï¼Œä½†æˆ‘ä¸æƒ³æƒ¹éº»çƒ¦ã€‚"],
          'èˆ’ä¿±': ["æ— è¶£çš„æŒ£æ‰ï¼Œæ¯ç­å§ã€‚", "æ— è®ºæ€ä¹ˆé€‰ï¼Œç»“å±€å·²å®šã€‚", "ä½ ä»¬å¤ªåµäº†ï¼Œæˆ‘æƒ³ç ¸äº†è¿™é‡Œã€‚", "å“¼ï¼Œå¼±è€…æ‰æŠ±å›¢ã€‚"]
        };
        
        let pool = thoughtsDB[player.name] || ["åœ¨æ€è€ƒä¸­..."];
        let txt = pool[Math.floor(Math.random() * pool.length)];
        openModal(`<strong>${player.name}çš„æƒ³æ³•ï¼š</strong>\n\nâ€œ${txt}â€`);
    }

    function addLog(text, isSystem=false) {
        let div = document.createElement('div');
        div.className = isSystem ? 'log-system' : 'log-entry';
        div.innerHTML = text;
        gameLog.appendChild(div);
        gameLog.scrollTop = gameLog.scrollHeight;
    }

    function startNight() {
        addLog(`<br>--- ç¬¬ ${round} å¤œ ---`, true);
        addLog("å¤©é»‘è¯·é—­çœ¼ï¼Œæ‰€æœ‰ç©å®¶è¯·æ ¹æ®èº«ä»½è¡ŒåŠ¨...");
        nightKillTarget = -1; guardTarget = -1; witchPoisonTarget = -1; savedByWitch = false;

        // NPC ç‹¼äººè¡ŒåŠ¨ï¼ˆå¦‚æœç©å®¶ä¸æ˜¯ç‹¼äººï¼‰
        if(players[1].role !== 'ç‹¼äºº') {
            let targets = players.filter(p => p.alive && p.role !== 'ç‹¼äºº');
            let smartTargets = targets.filter(p => p.name === 'æ‹‰å¸å¥¥' || p.role === 'é¢„è¨€å®¶');
            if(smartTargets.length > 0 && Math.random() > 0.5) {
                nightKillTarget = smartTargets[0].id;
            } else if(targets.length > 0) {
                nightKillTarget = targets[Math.floor(Math.random()*targets.length)].id;
            }
        }

        processUserNightAction();
    }

    function processUserNightAction() {
        const user = players[1];
        if(!user.alive) { 
          addLog("ï¼ˆä½ å·²å‡ºå±€ï¼Œçµé­‚æ¼‚æµ®åœ¨åŠç©ºè§‚æˆ˜...ï¼‰");
          setTimeout(simulateNight, 1500); 
          return; 
        }
        
        let options = [];
        if(user.role === 'ç‹¼äºº') {
          addLog("ä½ çš„åŒä¼´åœ¨æš—å¤„çœ‹ç€ä½ ã€‚ä»Šæ™šï¼Œè°å°†æˆä¸ºç¥­å“ï¼Ÿ");
          players.forEach(p => { if(p.alive && p.role !== 'ç‹¼äºº') options.push({label: `è¢­å‡» ${p.id+1}å· ${p.name}`, val: p.id}); });
          showOptions(options, (val) => { nightKillTarget = val; simulateNight(); });
        } else if(user.role === 'é¢„è¨€å®¶') {
          addLog("æ°´æ™¶çƒåœ¨é—ªçƒï¼Œä½ æƒ³çœ‹æ¸…è°çš„çœŸé¢ç›®ï¼Ÿ");
          players.forEach(p => { if(p.alive && p.id !== 1) options.push({label: `æŸ¥éªŒ ${p.id+1}å· ${p.name}`, val: p.id}); });
          showOptions(options, (val) => { 
            let isWolf = players[val].role === 'ç‹¼äºº';
            alert(`æŸ¥éªŒç»“æœï¼š${players[val].name} æ˜¯ ${isWolf ? 'ç‹¼äºº (åäºº)' : 'å¥½äºº'}`);
            simulateNight(); 
          });
        } else if(user.role === 'å¥³å·«') {
          processWitchAction();
        } else if(user.role === 'å®ˆå«') {
          addLog("ç›¾ç‰Œå·²å¤‡å¥½ï¼Œä»Šæ™šä½ è¦å®ˆæŠ¤è°çš„å®‰å®ï¼Ÿ");
          players.forEach(p => { if(p.alive && p.id !== lastGuardTarget) options.push({label: `å®ˆæŠ¤ ${p.id+1}å· ${p.name}`, val: p.id}); });
          options.push({label: "ç©ºå®ˆï¼ˆä¸å®ˆæŠ¤ä»»ä½•äººï¼‰", val: -1});
          showOptions(options, (val) => { guardTarget = val; lastGuardTarget = val; simulateNight(); });
        } else {
          addLog("ä½ æ˜¯å¹³æ°‘ï¼Œçª—å¤–é£å£°é¹¤å”³ï¼Œä½ è£¹ç´§äº†è¢«å­ç¡è§‰...");
          setTimeout(simulateNight, 1500); 
        }
    }

    function processWitchAction() {
        if (!witchHealUsed && nightKillTarget !== -1) {
            let deadName = players[nightKillTarget].name;
            if (nightKillTarget === 1) {
                addLog(`ä»Šæ™šè¢«æ€çš„æ˜¯ä½ ã€‚ç”±äºä¸èƒ½è‡ªæ•‘ï¼Œä½ åªèƒ½é€‰æ‹©æ˜¯å¦æ¯’äººã€‚`);
                askPoison();
            } else {
                addLog(`ä»Šæ™š <strong style="color:var(--aventurine-gold)">${deadName}</strong> è¢«æ€äº†ï¼Œä½ è¦ä½¿ç”¨çµè¯æ•‘ä»–å—ï¼Ÿ`);
                showOptions([
                    {label: "ä½¿ç”¨çµè¯æ•‘äºº", val: 'heal'},
                    {label: "ä¸æ•‘ï¼Œè¿›å…¥æ¯’è¯é˜¶æ®µ", val: 'no_heal'}
                ], (choice) => {
                    if (choice === 'heal') {
                        savedByWitch = true;
                        witchHealUsed = true;
                        simulateNight(); // æ•‘äº†äººä¸€èˆ¬ä¸èƒ½å†æ¯’äººï¼ˆæ ‡å‡†è§„åˆ™ï¼‰
                    } else {
                        askPoison();
                    }
                });
            }
        } else {
            askPoison();
        }
    }

    function askPoison() {
        if (!witchPoisonUsed) {
            addLog("ä½ æ‰‹ä¸­çš„æ¯’è¯æ­£å¾®å¾®å‘çƒ«ã€‚ä»Šæ™šè¦å¸¦èµ°è°å—ï¼Ÿ");
            let opts = [{label: "ä¸ä½¿ç”¨æ¯’è¯", val: -1}];
            players.forEach(p => { if(p.alive && p.id !== 1) opts.push({label: `æ¯’æ­» ${p.id+1}å· ${p.name}`, val: p.id}); });
            showOptions(opts, (val) => {
                if (val !== -1) {
                    witchPoisonTarget = val;
                    witchPoisonUsed = true;
                }
                simulateNight();
            });
        } else {
            addLog("ä½ å·²æ²¡æœ‰æ¯’è¯ï¼Œä»Šæ™šå¹³å®‰åº¦è¿‡ã€‚");
            setTimeout(simulateNight, 1000);
        }
    }

    function simulateNight() {
        hideOptions();
        
        let deadTonight = [];
        // ç»“ç®—æ­»äº¡é€»è¾‘ï¼šç‹¼äººæ€äºº - å®ˆå«å®ˆæŠ¤ - å¥³å·«æ•‘äºº
        if(nightKillTarget !== -1 && nightKillTarget !== guardTarget && !savedByWitch) {
            deadTonight.push(nightKillTarget);
        }
        // æ¯’è¯æ— è§†å®ˆæŠ¤
        if(witchPoisonTarget !== -1) {
            deadTonight.push(witchPoisonTarget);
        }
        
        [...new Set(deadTonight)].forEach(id => { if(id !== -1) players[id].alive = false; });
        
        setTimeout(startDay, 1500, [...new Set(deadTonight)]);
    }

    function startDay(deadList) {
        renderPlayers();
        addLog(`<br>--- ç¬¬ ${round} å¤© ---`, true);
        if(deadList.length > 0) {
          let deadNames = deadList.map(id => players[id].name).join(', ');
          addLog(`æ˜¨æ™šæ˜¯ä¸ªæƒ¨ç—›çš„å¤œæ™šï¼Œ<strong style="color:red;">${deadNames}</strong> å€’ç‰Œäº†ã€‚`);
        } else {
          addLog("æ˜¨æ™šæ˜¯ä¸ªå¹³å®‰å¤œï¼Œæ‰€æœ‰äººéƒ½çœ‹åˆ°äº†ä»Šå¤©çš„å¤ªé˜³ã€‚");
        }
        
        if(checkWinCondition()) return;
        setTimeout(() => startSpeeches(0), 1000);
    }

    function getNpcSpeech(p) {
        let suspects = players.filter(v => v.alive && v.id !== p.id);
        let target = suspects.length > 0 ? suspects[Math.floor(Math.random()*suspects.length)] : {name: "ç©ºæ°”"};
        
        if(p.name === 'ç ‚é‡‘') {
          if(p.role === 'ç‹¼äºº') {
            return [`å“å‘€ï¼Œæœ‹å‹ä»¬ï¼Œåˆ«è¿™ä¹ˆçœ‹ç€æˆ‘ã€‚æˆ‘å¯æ˜¯è‰¯æ°‘ã€‚`, `æˆ‘è§‰å¾—${target.name}ä¸å¤ªå¯¹åŠ²å“¦ã€‚`, `ä¿¡æˆ‘ï¼Œè¿™ç¬”äº¤æ˜“ç¨³èµšä¸èµ”ã€‚`, `æ‹‰å¸å¥¥æ•™æˆï¼Œè¿™å›æˆ‘çœŸæ²¡æ’’è°ã€‚`][round % 4];
          } else {
            return [`æœ‰äººåœ¨æ¼”æˆï¼Œè€Œä¸”æ¼”æŠ€å¾ˆæ‹™åŠ£ã€‚`, `æœ‹å‹ï¼Œé‚£ä¸ª${target.name}ï¼Œæ•¢ä¸æ•¢è·Ÿæˆ‘å¯¹èµŒä¸€æŠŠèº«ä»½ï¼Ÿ`, `æˆ‘æ˜¯ç¥èŒï¼Œä¸æƒ³æ­»å°±åˆ«æŠ•æˆ‘ã€‚`, `çœŸç†åŒ»ç”Ÿå¦‚æœæ­»äº†ï¼Œé‚£æˆ‘å°±æ˜¯åœºä¸Šæœ€èªæ˜çš„äººäº†ã€‚`][round % 4];
          }
        }
        if(p.name === 'æ‹‰å¸å¥¥') {
          return [`é›¶åˆ†ã€‚åœ¨åº§å„ä½çš„å‘è¨€æ¯«æ— é€»è¾‘å¯è¨€ã€‚`, `åŸºäºç›®å‰æ ·æœ¬ï¼Œ${target.name}çš„è¡Œä¸ºæä¸ç†æ€§ã€‚`, `æ„šè ¢ã€‚å»ºè®®é‡ç‚¹å…³æ³¨æ··æ·†è§†å¬çš„äººã€‚`, `æˆ‘æ˜¯é—­çœ¼ç©å®¶ï¼Œä½†æˆ‘æœ‰è„‘å­ã€‚`][round % 4];
        }
        if(p.name === 'æ‰˜å¸•') {
          return [`è´¦è´¦è¯´é‚£ä¸ªäººèº«ä¸Šæœ‰ç‹¼çš„å‘³é“ã€‚`, `è¿™å±€æ²¡ä»€ä¹ˆæœ‰ç”¨çš„ä¿¡æ¯ï¼Œå»ºè®®ç¨³ä¸€æ‰‹ã€‚`, `æˆ‘æ˜¯å¥½äººï¼ŒæŠ•æˆ‘å‡ºå»ä½ ä»¬ä¼šåæ‚”çš„ã€‚`, `ä¸ºäº†å¥½äººçš„èƒœåˆ©ï¼Œ${target.name}å¿…é¡»å‡ºå±€ã€‚`][round % 4];
        }
        return `æˆ‘æ˜¯å¥½äººï¼Œè¿‡ã€‚`;
    }

    function startSpeeches(playerIndex) {
        if(playerIndex >= players.length) { startVoting(); return; }
        const p = players[playerIndex];
        
        if(!p.alive) { startSpeeches(playerIndex + 1); return; }
        
        if(p.isUser) {
          generateUserSpeechOptions((speech) => {
          addLog(`<strong>${p.id+1}.${p.name}:</strong> ${speech}`);
          startSpeeches(playerIndex + 1);
          });
        } else {
          let speech = getNpcSpeech(p);
          setTimeout(() => {
          addLog(`<strong>${p.id+1}.${p.name}:</strong> ${speech}`);
          startSpeeches(playerIndex + 1);
          }, 1000 + Math.random() * 500);
        }
    }

    function generateUserSpeechOptions(callback) {
        addLog("è½®åˆ°ä½ äº†ï¼Œè¯·é€‰æ‹©ä½ çš„å‘è¨€ï¼š");
        let opts = [
          "ï¼ˆæ‰“å“ˆæ¬ ï¼‰å¤ªå›°äº†...æˆ‘æ˜¯å¥½äººï¼Œè¿‡ã€‚",
          "æˆ‘æ˜¯å¹³æ°‘ã€‚èƒ½ä¸èƒ½å¿«ç‚¹ç»“æŸï¼Ÿæˆ‘è¿˜è¦å›å»å†™æŠ¥å‘Š...",
          "æˆ‘è§‰å¾—ç ‚é‡‘æ€»ç›‘ä¸€ç›´åœ¨ç¬‘ï¼ŒçœŸçš„å¾ˆå¯ç–‘ï¼"
        ];
        if(players[4].alive) opts.push("æˆ‘ç›¸ä¿¡æ‹‰å¸å¥¥æ•™æˆçš„åˆ¤æ–­ï¼Œå¬ä»–çš„å‡†æ²¡é”™ã€‚");
        if(players[1].role === 'é¢„è¨€å®¶') opts.push("æˆ‘æ˜¯é¢„è¨€å®¶ï¼æ˜¨æ™šéªŒäº†ï¼Œä¿¡æˆ‘ï¼");

        let displayOpts = opts.sort(() => 0.5 - Math.random()).slice(0, 4);
        showOptions(displayOpts.map(t => ({label: t, val: t})), (val) => { hideOptions(); callback(val); });
    }

    function startVoting() {
        if(!players[1].alive) {
          addLog("<br>--- æŠ•ç¥¨é˜¶æ®µ (ä½ å·²å‡ºå±€) ---", true);
          setTimeout(() => resolveVotes(-1), 2000);
          return;
        }
        addLog("<br>--- æŠ•ç¥¨é˜¶æ®µ ---", true);
        let options = [];
        players.forEach(p => { if(p.alive && p.id !== 1) options.push({label: `æŠ•ç»™ ${p.id+1}å· ${p.name}`, val: p.id}); });
        options.push({label: "å¼ƒæƒ", val: -1});
        showOptions(options, (userVote) => { hideOptions(); resolveVotes(userVote); });
    }

    function resolveVotes(userVote) {
        let voteCounts = {};
        players.forEach(p => voteCounts[p.id] = 0);
        players.forEach(p => {
          if(!p.alive) return; 
          if(p.isUser) { if(userVote !== -1) voteCounts[userVote]++; }
          else {
            let targets = players.filter(t => t.alive && t.id !== p.id);
            if(targets.length > 0) voteCounts[targets[Math.floor(Math.random()*targets.length)].id]++;
          }
        });

        let maxVotes = 0, eliminated = -1, isTie = false;
        for(let pid in voteCounts) {
          if(voteCounts[pid] > maxVotes) { maxVotes = voteCounts[pid]; eliminated = pid; isTie = false; }
          else if(voteCounts[pid] === maxVotes && maxVotes > 0) isTie = true;
        }

        let summary = "<strong>æŠ•ç¥¨ç»“æœï¼š</strong><br>";
        for(let pid in voteCounts) { if(voteCounts[pid] > 0) summary += `${players[pid].name}: ${voteCounts[pid]}ç¥¨<br>`; }
        addLog(summary, true);

        if(eliminated !== -1 && !isTie) {
          addLog(`ç»è¿‡å…¬æŠ•ï¼Œ<strong>${players[eliminated].name}</strong> è¢«æ”¾é€å‡ºå±€ã€‚`);
          players[eliminated].alive = false;
        } else {
          addLog("å¹³ç¥¨æˆ–æ— äººå¾—ç¥¨ï¼Œæ— äººå‡ºå±€ã€‚");
        }
        
        renderPlayers();
        if(checkWinCondition()) return;
        round++; 
        setTimeout(startNight, 2000);
    }

    function checkWinCondition() {
        let wolves = players.filter(p => p.alive && p.role === 'ç‹¼äºº').length;
        let goods = players.filter(p => p.alive && p.role !== 'ç‹¼äºº').length;
        if(wolves === 0) { endGame('å¥½äººé˜µè¥èƒœåˆ©ï¼'); return true; }
        if(wolves >= goods) { endGame('ç‹¼äººé˜µè¥èƒœåˆ©ï¼'); return true; }
        return false;
    }

    function endGame(reason) {
        turnPhase = 'end';
        setTimeout(() => {
          document.getElementById('screen-game').classList.add('hidden');
          document.getElementById('screen-end').classList.remove('hidden');
          document.getElementById('winner-title').innerText = reason;
          document.getElementById('end-reason').innerText = `æ¸¸æˆåœ¨ç¬¬ ${round} å¤©è½å¹•ã€‚`;
          document.getElementById('end-roles').innerHTML = players.map(p => `<div>${p.name}: <strong style="color:var(--aventurine-gold)">${p.role}</strong> ${p.alive ? '' : '(äº¡)'}</div>`).join('');
        }, 1500);
    }

    function showOptions(opts, callback) {
        actionPanel.innerHTML = '';
        opts.forEach(o => {
          let btn = document.createElement('button');
          btn.className = 'option-btn';
          btn.innerText = o.label;
          btn.onclick = () => callback(o.val);
          actionPanel.appendChild(btn);
        });
        actionPanel.style.display = 'block';
    }

    function hideOptions() { actionPanel.style.display = 'none'; }

    function showReflection(who) { 
        if(who === 'char') openModal(`<strong>ç ‚é‡‘çš„ç©åæ„Ÿï¼š</strong>\n\nâ€œå“å‘€ï¼Œ${USER_NAME}ï¼Œè¿™åœºæ¸¸æˆå¯çœŸæ˜¯ç²¾å½©ã€‚çœ‹ç€ä½ åŠªåŠ›æƒ³è¦ä¿æŠ¤é‚£ä½â€˜æ‹‰å¸å¥¥æ•™æˆâ€™ï¼Œæˆ‘å¯æ˜¯å¿ç¬‘å¿å¾—å¾ˆè¾›è‹¦å‘¢ã€‚ä¸‹æ¬¡ï¼Œä¸å¦‚åªæœ‰æˆ‘ä»¬ä¸¤ä¸ªå•ç‹¬ç©ï¼Ÿâ€`);
        else openModal(`<strong>${USER_NAME}çš„ç©åæ„Ÿï¼š</strong>\n\nâ€œç»ˆäºç»“æŸäº†...æˆ‘çš„å¤´å¥½ç—›ã€‚ä¸ºä»€ä¹ˆè¦è¿ç©ä¸ªæ”¾æ¾çš„æ¸¸æˆéƒ½è¦è¿™ä¹ˆè´¹è„‘å­ï¼Ÿï¼â€`);
    }
    
    function openModal(text) {
        document.getElementById('modal-text').innerHTML = text.replace(/\n/g, '<br>');
        document.getElementById('thought-modal').classList.add('show');
    }
    function closeModal() { document.getElementById('thought-modal').classList.remove('show'); }
</script>

</body>
</html>